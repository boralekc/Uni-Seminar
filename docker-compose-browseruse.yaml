version: "3.9"

services:
  browseruse:
    image: browseruse:local
    build:
      context: .
      dockerfile: ./docker/BrowserUse.Dockerfile

    env_file: ./.env
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      FRONTEND_URL: ${FRONTEND_URL}
      SHOP1_URL: ${SHOP1_URL}
      SHOP2_URL: ${SHOP2_URL}
      SHOP3_URL: ${SHOP3_URL}
      SHOP4_URL: ${SHOP4_URL}
      TASKSET_PATH: /app/tasksets/subset_30_tasks.json
      RESULTS_DIR: ${RESULTS_DIR:-/app/results}

    volumes:
      - ./tasksets:/app/tasksets:ro
      - ./results:/app/results
      - ./runner:/app/runner:ro
    networks: [labnet]
    command:
      - bash
      - -lc
      - >
        set -euo pipefail;
        python /app/runner/run_browseruse_webmall_study.py

    healthcheck:
      test: ["CMD-SHELL", "python -c 'print(\"ok\")' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    restart: unless-stopped

networks:
  labnet:
    external: true
    name: ${NETWORK}
