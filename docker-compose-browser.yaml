version: "3.9"

services:
  browser-tests:
    build:
      context: .
      dockerfile: ./docker/BrowserAgent.Dockerfile
    image: browser:local
    env_file: .env
    environment:
      - WEBMALL_BASE_URL=${WEBMALL_BASE_URL}
      - TASKSET_PATH=${TASKSET_HOST_PATH}
      - RESULTS_DIR=/results
      - PYTHONPATH=/ext/webmall:/ext/core
      - FRONTEND_URL=${FRONTEND_URL}
      - SHOP1_URL=${SHOP1_URL}
      - SHOP2_URL=${SHOP2_URL}
      - SHOP3_URL=${SHOP3_URL}
      - SHOP4_URL=${SHOP4_URL}
      - EPISODES=${EPISODES:-1}
    shm_size: "2gb"
    ulimits:
      memlock: -1
      nofile: 65535
    volumes:
      - ${BGYM_PATH}:/ext/webmall:ro
      - ${BGYM_PATH}:/ext/core:ro
      - ./results/browser:/results
    networks: [labnet]
    command:
      - bash
      - -lc
      - |
        set -euo pipefail
        python /app/browseragent/run_browseragent.py \
          --taskset /tasksets/task_sets.json \
          --results /results \
          --episodes ${EPISODES:-1}
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; print(sys.getfilesystemencoding())' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped

networks:
  labnet:
    external: true
    name: ${NETWORK}
